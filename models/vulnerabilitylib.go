package models

import (
	"github.com/astaxie/beego/logs"
	"github.com/astaxie/beego/orm"
	"github.com/xiliangMa/diss-backend/utils"
	"net/http"
	"time"
)

type VulnerRule struct {
	CVE           string
	Component     string
	AffectVersion string
}

type VulnerabilityLib struct {
	Id                  int64                `orm:"pk;auto" description:"(Id)"`
	Language            string               `orm:"size(64);default(zh-cn)" description:"(语言)"`
	VId                 string               `orm:"size(64)" description:"(Kube-hunter Id)"`
	VCategory           string               `orm:"size(64)" description:"(Kube-hunter Category)"`
	CVEId               string               `orm:"size(64)" description:"(CVE Id)"`
	Cvss                string               `orm:"size(64)" description:"(CVSS)"`
	CvssScore           float32              `orm:"" description:"(CVSS Score)"`
	Access              string               `orm:"size(64)" description:"(访问方式)"`
	Type                string               `orm:"size(128)" description:"(风险类型)"`
	Category            string               `orm:"size(128)" description:"(应用类别: harbor , docker ,k8s)"`
	SubCategory         string               `orm:"size(128)" description:"(应用子类别: 如dockerEngine, runc, containerd)"`
	ResType             string               `orm:"size(128)" description:"(资源类型：如all, master, worker等)"`
	Name                string               `orm:"size(256)" description:"(风险项名)"`
	RiskProp            string               `orm:"size(128)" description:"(风险特征，多个)"`
	Severity            int                  `orm:"" description:"(风险等级)"`
	Description         string               `orm:"" description:"(描述信息)"`
	RiskInfoLink        string               `orm:"" description:"(RiskInf Link)"`
	RefLinks            string               `orm:"" description:"(Risk Ref Link)"`
	Recommend           string               `orm:"" description:"(修复建议)"`
	SuiteVersions       string               `orm:"" description:"(适用版本)"`
	PublishTime         int64                `orm:"" description:"(发布时间)"`
	Enabled             int                  `orm:"default(1)" description:"(是否启用：0查询全部 0禁用 1启用)"`
	CreateTime          int64                `orm:"" description:"(添加时间)"`
	UpdateTime          int64                `orm:"" description:"(修改时间)"`
	KubeVulnerabilities *KubeVulnerabilities `orm:"reverse(one)" description:"(kubernates vulnerabilities)"`
}

type VulnerabilityLibInterface interface {
	List(from, limit int) Result
	Add() Result
	Update() Result
	VulnerabilityList(from, limit int) ([]*VulnerabilityLib, int64, error)
	Delete() Result
	Get() (*VulnerabilityLib, error)
}

func (this *VulnerabilityLib) Add() Result {
	var ResultData Result
	o := orm.NewOrm()
	o.Using(utils.DS_Default)

	this.CreateTime = time.Now().UnixNano()
	this.UpdateTime = time.Now().UnixNano()
	if this.Enabled == 0 {
		this.Enabled = 1
	}
	_, err := o.Insert(this)
	if err != nil && utils.IgnoreLastInsertIdErrForPostgres(err) != nil {
		ResultData.Message = err.Error()
		ResultData.Code = utils.AddVulnerabilityLibErr
		logs.Error("Add VulnerabilityLib failed, code: %d, err: %s", ResultData.Code, ResultData.Message)
		return ResultData
	}
	ResultData.Code = http.StatusOK
	ResultData.Data = this

	return ResultData
}

func (this *VulnerabilityLib) Update() Result {
	o := orm.NewOrm()
	o.Using(utils.DS_Default)
	var ResultData Result

	vulnerObj := VulnerabilityLib{}
	vulnerObj.Id = this.Id
	vulnerData, _ := vulnerObj.Get()
	this.CreateTime = vulnerData.CreateTime
	this.UpdateTime = time.Now().UnixNano()

	_, err := o.Update(this)
	if err != nil {
		ResultData.Message = err.Error()
		ResultData.Code = utils.EditVulnerabilityLibErr
		logs.Error("Edit VulnerabilityLib %s failed, code: %d, err: %s", this.Name, ResultData.Code, ResultData.Message)
		return ResultData
	}

	ResultData.Code = http.StatusOK
	ResultData.Data = this
	return ResultData
}

func (this *VulnerabilityLib) List(from, limit int) Result {
	var ResultData Result

	vulnerList, total, err := this.VulnerabilityList(from, limit)

	if err != nil {
		ResultData.Message = err.Error()
		ResultData.Code = utils.GetVulnerabilityLibErr
		logs.Error("Get VulnerabilityLib failed, code: %d, err: %s", ResultData.Code, ResultData.Message)
	}

	data := make(map[string]interface{})
	data["total"] = total
	data["items"] = vulnerList
	if total == 0 {
		ResultData.Data = nil
	}

	ResultData.Code = http.StatusOK
	ResultData.Data = data
	return ResultData
}

func (this *VulnerabilityLib) Get() (*VulnerabilityLib, error) {
	o := orm.NewOrm()
	o.Using(utils.DS_Default)
	cond := orm.NewCondition()

	if this.Id != 0 {
		cond = cond.And("id", this.Id)
	}
	if this.VId != "" {
		cond = cond.And("v_id", this.VId)
	}

	vulnerLibData := VulnerabilityLib{}
	err := o.QueryTable(utils.VulnerabiltyLib).SetCond(cond).One(&vulnerLibData)

	return &vulnerLibData, err
}

func (this *VulnerabilityLib) VulnerabilityList(from, limit int) ([]*VulnerabilityLib, int64, error) {
	o := orm.NewOrm()
	o.Using(utils.DS_Default)
	var vulnerList []*VulnerabilityLib = nil
	cond := orm.NewCondition()

	if this.Id != 0 {
		cond = cond.And("id", this.Id)
	}
	if this.VId != "" {
		cond = cond.And("v_id", this.VId)
	}
	if this.Type != "" {
		cond = cond.And("type", this.Type)
	}
	if this.Name != "" {
		cond = cond.And("Name__contains", this.Name)
	}
	if this.CVEId != "" {
		cond = cond.And("CVEId__contains", this.CVEId)
	}
	if this.Category != "" {
		cond = cond.And("category", this.Category)
	}
	if this.Language == "" {
		cond = cond.And("language", Language_Cn)
	}

	if this.Enabled != 0 {
		cond = cond.And("enabled", this.Enabled)
	}

	_, err := o.QueryTable(utils.VulnerabiltyLib).SetCond(cond).Limit(limit, from).OrderBy("-risk_prop").All(&vulnerList)

	total, _ := o.QueryTable(utils.VulnerabiltyLib).SetCond(cond).Count()
	return vulnerList, total, err
}

func (this *VulnerabilityLib) Delete() Result {
	o := orm.NewOrm()
	o.Using(utils.DS_Default)
	var ResultData Result
	cond := orm.NewCondition()

	if this.Id != 0 {
		cond = cond.And("id", this.Id)
	} else {
		ResultData.Message = "No VulnerabilityLib Id."
		ResultData.Code = utils.DeleteVulnerabilityLibErr
		return ResultData
	}

	_, err := o.QueryTable(utils.VulnerabiltyLib).SetCond(cond).Delete()

	if err != nil {
		ResultData.Message = err.Error()
		ResultData.Code = utils.DeleteVulnerabilityLibErr
		logs.Error("Delete DeleteVulnerabilityLibErr failed, code: %d, err: %s", ResultData.Code, ResultData.Message)
		return ResultData
	}
	ResultData.Code = http.StatusOK
	return ResultData
}
